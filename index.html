<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>IP Lookup Tool â€” Dark Theme</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #121212;
      color: #ffffff;
      padding: 20px;
      margin: 0;
    }

    .card {
      background-color: #1e1e1e;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
      margin: 20px auto;
      max-width: 800px;
      padding: 25px;
    }

    input, button {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      border-radius: 6px;
      border: none;
      font-size: 16px;
    }

    input {
      background-color: #2c2c2c;
      color: #fff;
    }

    input::placeholder {
      color: #aaa;
    }

    button {
      background-color: #ffffff;
      color: #121212;
      font-weight: bold;
      cursor: pointer;
      transition: 0.2s;
    }

    button:hover {
      background-color: #e0e0e0;
    }

    dl {
      display: grid;
      grid-template-columns: 1fr 2fr;
      gap: 8px 16px;
    }

    dt {
      font-weight: bold;
      color: #bbbbbb;
    }

    dd pre {
      margin: 0;
      white-space: pre-wrap;
      word-break: break-word;
      color: #ffffff;
      background: #2c2c2c;
      padding: 6px;
      border-radius: 4px;
    }

    #map {
      height: 300px;
      margin-top: 20px;
      border-radius: 12px;
      border: 1px solid #333;
    }

    .download-buttons {
      margin-top: 15px;
      display: flex;
      gap: 10px;
    }

    .download-buttons button {
      flex: 1;
      background-color: #ffffff;
      color: #121212;
    }

    .download-buttons button:hover {
      background-color: #e0e0e0;
    }

    h2 {
      text-align: center;
      margin-bottom: 20px;
      color: #ffffff;
    }
  </style>

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>
<body>
  <div class="card">
    <h2>IP Lookup Tool</h2>
    <input id="ipInput" type="text" placeholder="Enter IPv4 or IPv6 address" />
    <button onclick="lookupIP()">Lookup</button>

    <div id="output"></div>

    <div class="download-buttons" id="downloadBtns" style="display:none;">
      <button onclick="downloadResult('json')">Download JSON</button>
      <button onclick="downloadResult('csv')">Download CSV</button>
    </div>

    <div id="map"></div>
  </div>

  <script>
    let lastResult = null;

    async function lookupIP() {
      const ip = document.getElementById('ipInput').value.trim();
      if (!ip) return alert('Please enter an IP address.');

      const apiKey = '628960c99ac34992940f56d8e012b05f';
      const url = `https://api.ipgeolocation.io/ipgeo?apiKey=${apiKey}&ip=${encodeURIComponent(ip)}`;

      const container = document.getElementById('output');
      container.innerHTML = '<p>Loading...</p>';
      document.getElementById('downloadBtns').style.display = 'none';

      try {
        const res = await fetch(url);
        const data = await res.json();

        if (data.message) {
          container.innerHTML = `<p style="color: red;">Error: ${data.message}</p>`;
          return;
        }

        const fields = {
          'IP': data.ip,
          'Continent': data.continent_name,
          'Country': `${data.country_name} (${data.country_code2})`,
          'Country TLD': data.country_tld,
          'Calling Code': data.calling_code,
          'State/Region': data.state_prov,
          'City': data.city,
          'Latitude': data.latitude,
          'Longitude': data.longitude,
          'ISP': data.isp,
          'Organization': data.organization,
          'ASN': data.asn ? `${data.asn.name} (AS${data.asn.asn})` : '',
          'Timezone': data.time_zone ? data.time_zone.name : '',
          'Timezone Offset': data.time_zone ? data.time_zone.offset : '',
          'Current Time': data.time_zone ? data.time_zone.current_time : '',
          'Is DST?': data.time_zone ? data.time_zone.is_dst : '',
          'Currency': data.currency ? `${data.currency.name} (${data.currency.code}, ${data.currency.symbol})` : '',
          'Languages': data.languages
        };

        lastResult = fields;

        let html = '<dl>';
        Object.entries(fields).forEach(([k,v]) => {
          if (v) html += `<dt>${k}</dt><dd><pre>${v}</pre></dd>`;
        });
        html += '</dl>';
        container.innerHTML = html;

        document.getElementById('downloadBtns').style.display = 'flex';

        if (data.latitude && data.longitude) {
          const mapDiv = document.getElementById('map');
          mapDiv.innerHTML = '';
          const map = L.map('map').setView([data.latitude, data.longitude], 8);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
          }).addTo(map);
          L.marker([data.latitude, data.longitude]).addTo(map)
            .bindPopup(`${data.city}, ${data.country_name}`)
            .openPopup();
        }

      } catch (err) {
        console.error(err);
        container.innerHTML = '<p style="color: red;">Request failed. Check console.</p>';
      }
    }

    function downloadResult(format) {
      if (!lastResult) return alert("No data to download!");
      let blob, filename;
      if (format === 'json') {
        blob = new Blob([JSON.stringify(lastResult, null, 2)], {type: "application/json"});
        filename = "ip-lookup.json";
      } else if (format === 'csv') {
        const rows = Object.entries(lastResult).map(([k,v]) => `"${k}","${v}"`);
        blob = new Blob([rows.join("\n")], {type: "text/csv"});
        filename = "ip-lookup.csv";
      }
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>
